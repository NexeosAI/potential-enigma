<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>McCaigs Education AI Suite – Licensing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://js.stripe.com/v3/"></script>
  </head>
  <body
    class="bg-slate-950 text-slate-100 min-h-screen"
    data-supabase-url="SUPABASE_URL_PLACEHOLDER"
    data-supabase-anon-key="SUPABASE_ANON_KEY_PLACEHOLDER"
    data-licence-server-url="LICENCE_SERVER_URL_PLACEHOLDER"
    data-stripe-publishable-key="STRIPE_PUBLISHABLE_KEY_PLACEHOLDER"
    data-paypal-client-id="PAYPAL_CLIENT_ID_PLACEHOLDER"
  >
    <main class="max-w-4xl mx-auto px-4 py-16" id="app">
      <header class="text-center space-y-4">
        codex/create-working-plan-from-agents.md-0qnebh
        <h1 class="text-4xl font-semibold" id="brandName">McCaigs Education AI Suite</h1>
        <p class="text-slate-300" id="brandTagline">Local-first AI tools for students and educators.</p>

        <h1 class="text-4xl font-semibold" id="brandName">
          McCaigs Education AI Suite
        </h1>
        <p class="text-slate-300" id="brandTagline">
          Local-first AI tools for students and educators.
        </p>
       main
      </header>

      <section class="mt-12 grid md:grid-cols-2 gap-8">
        <div class="bg-slate-900 border border-slate-700 rounded-xl p-6 space-y-4">
          <h2 class="text-2xl font-semibold">Secure your lifetime licence</h2>
         codex/create-working-plan-from-agents.md-0qnebh
          <label class="block text-sm text-slate-300" for="emailInput">Email address for receipt + licence delivery</label>

          <label class="block text-sm text-slate-300" for="emailInput"
            >Email address for receipt + licence delivery</label
          >
         main
          <input
            id="emailInput"
            type="email"
            required
            placeholder="you@example.com"
            class="w-full px-3 py-2 rounded-md bg-slate-950 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-amber-500"
          />
          <p id="tierPrice" class="text-lg">Loading pricing...</p>
          <div class="space-y-2">
            <div class="flex justify-between text-sm text-slate-400">
              <span>Licences sold</span>
              <span id="tierProgressLabel">0 / 0</span>
            </div>
            <div class="w-full bg-slate-800 rounded-full h-3">
              <div
                id="tierProgressBar"
                class="bg-amber-400 h-3 rounded-full"
                style="width: 0%"
              ></div>
            </div>
          </div>
          <p class="text-sm text-slate-400" id="tierNote"></p>
          <button
            id="stripeButton"
            class="w-full py-3 rounded-lg bg-amber-500 text-slate-950 font-semibold hover:bg-amber-400 transition"
          >
            Purchase with Stripe
          </button>
          <div id="paypalContainer"></div>
          <p class="text-sm text-amber-400" id="message"></p>
        </div>

        <div class="bg-slate-900 border border-slate-700 rounded-xl p-6 space-y-4">
          <h2 class="text-2xl font-semibold">What you receive</h2>
          <ul class="space-y-3 text-slate-300 list-disc list-inside">
            <li>Lifetime access to StudentlyAI mobile + desktop</li>
            <li>Local GGUF models with cloud fallback</li>
            <li>Access to add-on marketplace</li>
            <li>3 device activations with offline grace mode</li>
          </ul>
        </div>
      </section>
    </main>

    <script type="module">
         codex/create-working-plan-from-agents.md-0qnebh
      import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

      const BRAND_CONFIG = {
        studentlyai: {
          name: 'StudentlyAI',
          tagline: 'Your local-first study companion.',
          primary: 'rgb(249 115 22)',
        },
        studentsai_uk: {
          name: 'StudentsAI UK',
          tagline: 'Academic excellence for UK learners.',
          primary: 'rgb(30 58 138)',
        },
        studentsai_us: {
          name: 'StudentsAI US',
          tagline: 'Study smarter with trusted AI.',
          primary: 'rgb(3 105 161)',
        }
      };

      const dataset = document.body.dataset;
      const urlParams = new URLSearchParams(window.location.search);
      const brandKey = urlParams.get('brand') ?? 'studentlyai';
      const brand = BRAND_CONFIG[brandKey] ?? BRAND_CONFIG.studentlyai;


      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

      const BRAND_CONFIG = {
        studentlyai: {
          name: "StudentlyAI",
          tagline: "Your local-first study companion.",
          primary: "rgb(249 115 22)",
          currency: "£",
        },
        studentsai_uk: {
          name: "StudentsAI UK",
          tagline: "Academic excellence for UK learners.",
          primary: "rgb(30 58 138)",
          currency: "£",
        },
        studentsai_us: {
          name: "StudentsAI US",
          tagline: "Study smarter with trusted AI.",
          primary: "rgb(3 105 161)",
          currency: "$",
        },
      };

      const urlParams = new URLSearchParams(window.location.search);
      const brandKey = urlParams.get("brand") ?? "studentlyai";
      const brand = BRAND_CONFIG[brandKey] ?? BRAND_CONFIG.studentlyai;

      const dataset = document.body.dataset;
       main
      const config = {
        supabaseUrl: dataset.supabaseUrl,
        supabaseAnonKey: dataset.supabaseAnonKey,
        licenceServerUrl: dataset.licenceServerUrl,
        stripePublishableKey: dataset.stripePublishableKey,
        paypalClientId: dataset.paypalClientId,
      };

      codex/create-working-plan-from-agents.md-0qnebh
      const messageEl = document.getElementById('message');
      const emailInput = document.getElementById('emailInput');
      const tierPriceEl = document.getElementById('tierPrice');
      const tierProgressLabel = document.getElementById('tierProgressLabel');
      const tierProgressBar = document.getElementById('tierProgressBar');
      const tierNoteEl = document.getElementById('tierNote');

      const brandNameEl = document.getElementById('brandName');
      const brandTaglineEl = document.getElementById('brandTagline');

      const messageEl = document.getElementById("message");
      const emailInput = document.getElementById("emailInput");
      const tierPriceEl = document.getElementById("tierPrice");
      const tierProgressLabel = document.getElementById("tierProgressLabel");
      const tierProgressBar = document.getElementById("tierProgressBar");
      const tierNoteEl = document.getElementById("tierNote");

      const brandNameEl = document.getElementById("brandName");
      const brandTaglineEl = document.getElementById("brandTagline");
       main
      brandNameEl.textContent = brand.name;
      brandTaglineEl.textContent = brand.tagline;
      tierProgressBar.style.backgroundColor = brand.primary;

      codex/create-working-plan-from-agents.md-0qnebh
      const supabaseUrl = config.supabaseUrl && config.supabaseUrl !== 'SUPABASE_URL_PLACEHOLDER' ? config.supabaseUrl : null;
      const supabaseAnonKey =
        config.supabaseAnonKey && config.supabaseAnonKey !== 'SUPABASE_ANON_KEY_PLACEHOLDER'

      const supabaseUrl =
        config.supabaseUrl && config.supabaseUrl !== "SUPABASE_URL_PLACEHOLDER"
          ? config.supabaseUrl
          : null;
      const supabaseAnonKey =
        config.supabaseAnonKey &&
        config.supabaseAnonKey !== "SUPABASE_ANON_KEY_PLACEHOLDER"
         main
          ? config.supabaseAnonKey
          : null;

      if (!supabaseUrl || !supabaseAnonKey) {
       codex/create-working-plan-from-agents.md-0qnebh
        messageEl.textContent = 'Supabase credentials missing. Update data attributes before deploying.';
      }

      const supabase = supabaseUrl && supabaseAnonKey ? createClient(supabaseUrl, supabaseAnonKey) : null;

      async function fetchTier() {
        if (!supabase) {
          return null;
        }
        const { data, error } = await supabase.rpc('get_current_tier', { p_brand_id: brandKey });
        if (error) {
          console.error('Failed to load tier', error);
          messageEl.textContent = 'Unable to load tier data. Please refresh or try again later.';

        messageEl.textContent =
          "Supabase credentials missing. Update data attributes before deploying.";
      }

      const supabase =
        supabaseUrl && supabaseAnonKey
          ? createClient(supabaseUrl, supabaseAnonKey)
          : null;

      async function fetchTier() {
        if (!supabase) return null;
        const { data, error } = await supabase.rpc("get_current_tier", {
          p_brand_id: brandKey,
        });
        if (error) {
          console.error("Failed to load tier", error);
          messageEl.textContent =
            "Unable to load tier data. Please refresh or try again later.";
        main
          return null;
        }
        const tier = Array.isArray(data) ? data[0] : data;
        return tier;
      }

      let currencyCache = null;
      async function fetchBrandCurrency() {
       codex/create-working-plan-from-agents.md-0qnebh
        if (currencyCache) {
          return currencyCache;
        }
        if (!supabase) {
          currencyCache = brandKey.includes('us') ? 'USD' : 'GBP';
          return currencyCache;
        }
        const { data, error } = await supabase
          .from('brands')
          .select('default_currency')
          .eq('id', brandKey)
          .maybeSingle();
        if (error) {
          console.warn('Currency lookup failed', error);
          currencyCache = brandKey.includes('us') ? 'USD' : 'GBP';
          return currencyCache;
        }
        currencyCache = data?.default_currency ?? (brandKey.includes('us') ? 'USD' : 'GBP');

        if (currencyCache) return currencyCache;
        if (!supabase) {
          currencyCache = brandKey.includes("us") ? "USD" : "GBP";
          return currencyCache;
        }
        const { data, error } = await supabase
          .from("brands")
          .select("default_currency")
          .eq("id", brandKey)
          .maybeSingle();
        if (error) {
          console.warn("Currency lookup failed", error);
          currencyCache = brandKey.includes("us") ? "USD" : "GBP";
          return currencyCache;
        }
        currencyCache =
          data?.default_currency ??
          (brandKey.includes("us") ? "USD" : "GBP");
         main
        return currencyCache;
      }

      function formatCurrency(currency, amount) {
        const formatter = new Intl.NumberFormat(undefined, {
       codex/create-working-plan-from-agents.md-0qnebh
          style: 'currency',

          style: "currency",
       main
          currency,
          minimumFractionDigits: 2,
        });
        return formatter.format(amount);
      }

      fetchTier().then(async (tier) => {
      codex/create-working-plan-from-agents.md-0qnebh
        if (!tier) {
          return;
        }

        const currency = await fetchBrandCurrency();
        tierPriceEl.textContent = `${formatCurrency(currency, tier.price)} lifetime`;
        const capLabel = tier.cap ? tier.cap.toLocaleString() : '∞';
        tierProgressLabel.textContent = `${tier.sold.toLocaleString()} / ${capLabel}`;
        const progress = tier.cap ? Math.min(100, (tier.sold / tier.cap) * 100) : 0;
        tierProgressBar.style.width = `${Number.isFinite(progress) ? progress : 0}%`;
        tierNoteEl.textContent = tier.cap
          ? `${capLabel} licences available before price increases to the next tier.`
          : 'Final tier – price will not increase further.';

        if (!tier) return;

        const currency = await fetchBrandCurrency();
        tierPriceEl.textContent = `${formatCurrency(currency, tier.price)} lifetime`;
        const capLabel = tier.cap ? tier.cap.toLocaleString() : "∞";
        tierProgressLabel.textContent = `${tier.sold.toLocaleString()} / ${capLabel}`;
        const progress = tier.cap
          ? Math.min(100, (tier.sold / tier.cap) * 100)
          : 0;
        tierProgressBar.style.width = `${
          Number.isFinite(progress) ? progress : 0
        }%`;
        tierNoteEl.textContent = tier.cap
          ? `${capLabel} licences available before price increases to the next tier.`
          : "Final tier – price will not increase further.";
       main
      });

      function requireEmail() {
        if (!emailInput.value) {
       codex/create-working-plan-from-agents.md-0qnebh
          messageEl.textContent = 'Enter your email address to continue.';
          emailInput.focus();
          return false;
        }
        messageEl.textContent = '';

          messageEl.textContent = "Enter your email address to continue.";
          emailInput.focus();
          return false;
        }
        messageEl.textContent = "";
       main
        return true;
      }

      const stripeKey =
      codex/create-working-plan-from-agents.md-0qnebh
        config.stripePublishableKey && config.stripePublishableKey !== 'STRIPE_PUBLISHABLE_KEY_PLACEHOLDER'
          ? config.stripePublishableKey
          : null;
      const stripePromise = stripeKey && window.Stripe ? Promise.resolve(window.Stripe(stripeKey)) : null;

      document.getElementById('stripeButton').addEventListener('click', async () => {
        if (!requireEmail()) {
          return;
        }
        if (!config.licenceServerUrl || config.licenceServerUrl === 'LICENCE_SERVER_URL_PLACEHOLDER') {
          messageEl.textContent = 'Checkout server URL missing. Update deployment configuration.';
          return;
        }
        try {
          const response = await fetch(`${config.licenceServerUrl}/create-checkout-session`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              brandId: brandKey,
              email: emailInput.value,
              provider: 'stripe',
              successUrl: `${window.location.origin}/success?brand=${brandKey}`,
              cancelUrl: `${window.location.origin}/cancelled?brand=${brandKey}`,
            }),
          });

          const payload = await response.json();
          if (!response.ok) {
            messageEl.textContent = payload.error ?? 'Unable to start Stripe checkout.';
            return;
          }

          if (stripePromise && payload.sessionId) {
            const stripe = await stripePromise;
            await stripe.redirectToCheckout({ sessionId: payload.sessionId });
          } else if (payload.checkoutUrl) {
            window.location.href = payload.checkoutUrl;
          }
        } catch (error) {
          console.error('Stripe checkout failed', error);
          messageEl.textContent = 'Stripe checkout failed. Please try again.';
        }
      });

      const paypalClientId =
        config.paypalClientId && config.paypalClientId !== 'PAYPAL_CLIENT_ID_PLACEHOLDER'

        config.stripePublishableKey &&
        config.stripePublishableKey !== "STRIPE_PUBLISHABLE_KEY_PLACEHOLDER"
          ? config.stripePublishableKey
          : null;
      const stripePromise =
        stripeKey && window.Stripe
          ? Promise.resolve(window.Stripe(stripeKey))
          : null;

      document
        .getElementById("stripeButton")
        .addEventListener("click", async () => {
          if (!requireEmail()) return;
          if (
            !config.licenceServerUrl ||
            config.licenceServerUrl === "LICENCE_SERVER_URL_PLACEHOLDER"
          ) {
            messageEl.textContent =
              "Checkout server URL missing. Update deployment configuration.";
            return;
          }
          try {
            const response = await fetch(
              `${config.licenceServerUrl}/create-checkout-session`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  brandId: brandKey,
                  email: emailInput.value,
                  provider: "stripe",
                  successUrl: `${window.location.origin}/success?brand=${brandKey}`,
                  cancelUrl: `${window.location.origin}/cancelled?brand=${brandKey}`,
                }),
              }
            );

            const payload = await response.json();
            if (!response.ok) {
              messageEl.textContent =
                payload.error ?? "Unable to start Stripe checkout.";
              return;
            }

            if (stripePromise && payload.sessionId) {
              const stripe = await stripePromise;
              await stripe.redirectToCheckout({
                sessionId: payload.sessionId,
              });
            } else if (payload.checkoutUrl) {
              window.location.href = payload.checkoutUrl;
            }
          } catch (error) {
            console.error("Stripe checkout failed", error);
            messageEl.textContent = "Stripe checkout failed. Please try again.";
          }
        });

      const paypalClientId =
        config.paypalClientId &&
        config.paypalClientId !== "PAYPAL_CLIENT_ID_PLACEHOLDER"
         main
          ? config.paypalClientId
          : null;

      if (paypalClientId) {
        fetchBrandCurrency().then((currency) => {
         codex/create-working-plan-from-agents.md-0qnebh
          const paypalScript = document.createElement('script');
=======
          const paypalScript = document.createElement("script");
         main
          paypalScript.src = `https://www.paypal.com/sdk/js?client-id=${paypalClientId}&currency=${currency}`;
          paypalScript.onload = renderPaypalButton;
          document.head.appendChild(paypalScript);
        });
      }

      async function renderPaypalButton() {
     codex/create-working-plan-from-agents.md-0qnebh
        if (!window.paypal) {
          return;
        }

        if (!window.paypal) return;
       main
        const currency = await fetchBrandCurrency();
        window.paypal
          .Buttons({
            createOrder: async () => {
       codex/create-working-plan-from-agents.md-0qnebh
              if (!requireEmail()) {
                throw new Error('Email required');
              }
              if (!config.licenceServerUrl || config.licenceServerUrl === 'LICENCE_SERVER_URL_PLACEHOLDER') {
                messageEl.textContent = 'Checkout server URL missing. Update deployment configuration.';
                throw new Error('Checkout server URL missing');
              }
              const response = await fetch(`${config.licenceServerUrl}/create-checkout-session`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  brandId: brandKey,
                  email: emailInput.value,
                  provider: 'paypal',
                  successUrl: `${window.location.origin}/success?brand=${brandKey}`,
                  cancelUrl: `${window.location.origin}/cancelled?brand=${brandKey}`,
                }),
              });
              const payload = await response.json();
              if (!response.ok) {
                messageEl.textContent = payload.error ?? 'Unable to start PayPal checkout.';
                throw new Error(payload.error ?? 'PayPal checkout failed');

              if (!requireEmail()) throw new Error("Email required");
              if (
                !config.licenceServerUrl ||
                config.licenceServerUrl === "LICENCE_SERVER_URL_PLACEHOLDER"
              ) {
                messageEl.textContent =
                  "Checkout server URL missing. Update deployment configuration.";
                throw new Error("Checkout server URL missing");
              }
              const response = await fetch(
                `${config.licenceServerUrl}/create-checkout-session`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    brandId: brandKey,
                    email: emailInput.value,
                    provider: "paypal",
                    successUrl: `${window.location.origin}/success?brand=${brandKey}`,
                    cancelUrl: `${window.location.origin}/cancelled?brand=${brandKey}`,
                  }),
                }
              );
              const payload = await response.json();
              if (!response.ok) {
                messageEl.textContent =
                  payload.error ?? "Unable to start PayPal checkout.";
                throw new Error(payload.error ?? "PayPal checkout failed");
       main
              }
              return payload.orderId;
            },
            onApprove: async (data, actions) => {
       codex/create-working-plan-from-agents.md-0qnebh
              messageEl.textContent = 'Processing PayPal payment…';
              try {
                await actions.order?.capture();
                messageEl.textContent = 'Payment received! Check your email for the licence code.';
              } catch (error) {
                console.error('PayPal capture failed', error);
                messageEl.textContent = 'PayPal capture failed. Please contact support.';
              }
            },
            onError: (error) => {
              console.error('PayPal error', error);
              messageEl.textContent = 'PayPal checkout failed. Please try again.';
            },
          })
          .render('#paypalContainer');

              messageEl.textContent = "Processing PayPal payment…";
              try {
                await actions.order?.capture();
                messageEl.textContent =
                  "Payment received! Check your email for the licence code.";
              } catch (error) {
                console.error("PayPal capture failed", error);
                messageEl.textContent =
                  "PayPal capture failed. Please contact support.";
              }
            },
            onError: (error) => {
              console.error("PayPal error", error);
              messageEl.textContent =
                "PayPal checkout failed. Please try again.";
            },
          })
          .render("#paypalContainer");
       main
      }
    </script>
  </body>
</html>
